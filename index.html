<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador Estadístico Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5;
            background-image: linear-gradient(135deg, #eef2ff 0%, #f0f2f5 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        main { flex: 1; }
        .main-card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 30px -15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .accordion-item summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .accordion-item summary:hover { background-color: #f3f4f6; }
        .accordion-item summary::after { content: '▼'; font-size: 1rem; transition: transform 0.3s ease-in-out; }
        .accordion-item[open] > summary::after { transform: rotate(-180deg); }
        .accordion-content {
            padding: 1.5rem; border: 1px solid #e5e7eb; border-top: none;
            border-bottom-left-radius: 0.75rem; border-bottom-right-radius: 0.75rem;
        }
        .calculation-step { margin-bottom: 1.5rem; }
        .calculation-step h4 {
            font-weight: 600; color: #4b5563; margin-bottom: 0.75rem;
            border-bottom: 2px solid #10b981; padding-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;
        }
        .scrollable-equation {
            overflow-x: auto;
            white-space: nowrap;
            background-color: #f3f4f6;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }
        /* Chart Styles */
        .chart-container { width: 100%; padding: 2.5rem 1.5rem 4rem 3.5rem; position: relative; }
        .chart-title { text-align: center; font-size: 1.25rem; font-weight: 600; margin-bottom: 2.5rem; }
        .y-axis-title, .x-axis-title { position: absolute; font-size: 1rem; color: #4b5563; font-weight: 500; }
        .y-axis-title { left: -3.5rem; top: 50%; transform: translateY(-50%) rotate(-90deg); }
        .x-axis-title { bottom: -3.0rem; left: 50%; transform: translateX(-50%); }
         .chart-scroll-wrapper { width: 100%; overflow-x: auto; padding-bottom: 15px; }
        .chart { 
            display: flex; align-items: flex-end; height: 300px;
            border-left: 1px solid #d1d5db; border-bottom: 1px solid #d1d5db; 
            position: relative; 
            background-image: repeating-linear-gradient(to bottom, #f3f4f6, #f3f4f6 1px, transparent 1px, transparent 20%);
            background-size: 100% 100%;
            min-width: fit-content; 
        }
        .bar-wrapper { 
            display: flex; flex-direction: column; align-items: center; 
            min-width: 60px; position: relative; height:100%; border-right: 1px solid #f3f4f6; 
            flex-shrink: 0; 
        }
        .bar-wrapper:last-child { border-right: none; }
        .bar { width: 80%; border: 1px solid rgba(0,0,0,0.1); position: absolute; bottom: 0; left: 10%; border-radius: 4px 4px 0 0;}
        .bar-label { position: absolute; top: -24px; width: 100%; text-align: center; font-size: 0.75rem; font-weight: 600; color: #1f2937; }
        .interval-label { position: absolute; bottom: -28px; font-size: 0.75rem; color: #4b5563; left: 50%; transform: translateX(-50%); white-space: nowrap;}
        .mean-line { position: absolute; bottom: 0; top: 0; border-left: 3px dashed #ef4444; z-index: 10;}
        .mean-legend { 
            position: absolute; top: 10px; right: 15px; color: #ef4444; font-size: 0.9rem; font-weight: 700; z-index: 11;
            text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
        }
        /* Tables */
        .result-table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
        .result-table th, .result-table td { border: 1px solid #e5e7eb; padding: 0.5rem; text-align: center; font-size: 0.75rem; }
        .result-table th { background-color: #f9fafb; font-weight: 600; }
        .direct-stats-table td { padding: 0.75rem 1rem; font-size: 0.9rem; }
        .direct-stats-table td:first-child { font-weight: 600; color: #374151; }
        .direct-stats-table td:last-child { font-weight: 600; color: #4f46e5; text-align: right; }
        /* WhatsApp Button */
        .whatsapp-float { position: fixed; width: 60px; height: 60px; bottom: 40px; right: 40px; background-color: #25d366; color: #FFF; border-radius: 50px; text-align: center; font-size: 30px; box-shadow: 2px 2px 3px #999; z-index: 100; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .whatsapp-float:hover { transform: scale(1.1); background-color: #1DA851; }
        .whatsapp-float svg { width: 35px; height: 35px; }
        /* Footer */
        footer.app-footer { background-color: #111827; color: #9ca3af; padding: 2rem 1rem; margin-top: 2rem; border-top: 5px solid #4f46e5; }
        footer.app-footer h4 { color: #e5e7eb; font-weight: 600; margin-bottom: 1rem; }
        footer.app-footer ul { list-style: none; padding: 0; }
        footer.app-footer a { color: #9ca3af; text-decoration: none; transition: color 0.2s; }
        footer.app-footer a:hover { color: #e5e7eb; }
        footer.app-footer .copyright { margin-top: 2rem; border-top: 1px solid #374151; padding-top: 1rem; font-size: 0.875rem; text-align: center; }
        /* Animations & Utils */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .copy-btn { background: none; border: none; cursor: pointer; color: #9ca3af; }
        .copy-btn:hover { color: #4f46e5; }

        @media (min-width: 640px) { /* sm */
            .result-table th, .result-table td { font-size: 0.875rem; }
            .chart-container { padding: 2.5rem 3rem 4rem 4.5rem; }
            .bar-label, .interval-label { font-size: 0.875rem; }
            .whatsapp-float { bottom: 30px; right: 30px; }
        }
        @media (min-width: 768px) { /* md */
            footer.app-footer { padding: 3rem 2rem; }
        }
    </style>
</head>
<body class="p-2 sm:p-4">

    <main class="w-full max-w-6xl mx-auto space-y-8">
        <div class="main-card p-6 sm:p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Analizador Estadístico Profesional</h1>
                <p class="text-gray-500 mt-2 text-md sm:text-lg">Una herramienta interactiva para el análisis descriptivo de datos. <br>¿Encontraste una falla o tienes sugerencias? ¡Contáctame por WhatsApp!</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                <div>
                    <label for="rawData" class="block text-md font-medium text-gray-700 mb-2">Pega tu base de datos:</label>
                    <textarea id="rawData" rows="10" class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm" placeholder="Ej: 4.68, 6.27, 7.70, 4.99..."></textarea>
                </div>
                <div class="space-y-6">
                     <div>
                        <label for="variableName" class="block text-md font-medium text-gray-700 mb-2">Nombre de la Variable:</label>
                        <input type="text" id="variableName" value="Variable" class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm" placeholder="Ej: Nivel de pH">
                    </div>
                     <div>
                        <label for="histColor" class="block text-md font-medium text-gray-700 mb-2">Color del Histograma:</label>
                        <input type="color" id="histColor" value="#34d399" class="w-full h-14 p-1 border border-gray-300 rounded-xl cursor-pointer shadow-sm">
                    </div>
                    
                    <!-- Selector de Tipo de Análisis ELIMINADO -->

                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                        <button id="analyzeBtn" class="w-full bg-indigo-600 text-white font-bold py-4 px-4 rounded-xl hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center">
                            <svg id="analyzeBtnIcon" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2z"></path></svg>
                            <span id="analyzeBtnText">Analizar</span>
                        </button>
                    </div>
                    <div class="flex space-x-4 w-full">
                        <button id="loadSampleIntBtn" class="w-1/3 bg-emerald-500 text-white font-bold py-2 px-3 rounded-xl hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition duration-300 ease-in-out transform hover:scale-105 shadow-lg text-sm">Ej: Enteros (200)</button>
                        <button id="loadSampleDec2Btn" class="w-1/3 bg-teal-500 text-white font-bold py-2 px-3 rounded-xl hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition duration-300 ease-in-out transform hover:scale-105 shadow-lg text-sm">Ej: Decim (2dp)</button>
                        <button id="loadSampleDec4Btn" class="w-1/3 bg-cyan-500 text-white font-bold py-2 px-3 rounded-xl hover:bg-cyan-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 transition duration-300 ease-in-out transform hover:scale-105 shadow-lg text-sm">Ej: Decim (4dp)</button>
                    </div>
                     <p class="text-xs text-gray-500 text-center mt-2">Nota: Grandes cantidades de datos (>10,000) pueden ralentizar el navegador.</p>
                </div>
            </div>
        </div>
        
        <div id="results" class="space-y-8">
             <div id="initialState" class="main-card p-8 text-center fade-in">
                <svg class="w-24 h-24 mx-auto text-indigo-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V8a2 2 0 00-2-2H6a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                <h2 class="text-2xl font-bold text-gray-700 mt-4">Listo para Analizar</h2>
                <p class="text-gray-500 mt-2">Pega tus datos en el área de texto o carga un conjunto de datos de ejemplo para comenzar.</p>
            </div>
        </div>
    </main>
    
    <a href="https://wa.me/51903422507" class="whatsapp-float" target="_blank" rel="noopener noreferrer" aria-label="Contactar por WhatsApp">
        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12.04 2c-5.46 0-9.9 4.44-9.9 9.9 0 1.77.47 3.45 1.37 4.9L2 22l5.25-1.37c1.45.9 3.13 1.37 4.9 1.37 5.46 0 9.9-4.44 9.9-9.9s-4.44-9.9-9.9-9.9zm0 18c-1.58 0-3.06-.45-4.34-1.23l-.31-.18-3.26.85.87-3.18-.2-.33c-.8-1.29-1.23-2.77-1.23-4.31 0-4.31 3.5-7.81 7.81-7.81s7.81 3.5 7.81 7.81-3.5 7.81-7.81 7.81zm4.07-5.96c-.22-.11-.79-.39-.92-.44-.13-.05-.22-.05-.31.05-.09.11-.34.44-.42.54-.07.11-.15.11-.28.05-.13-.05-.55-.2-.7-.29-.14-.08-.28-.18-.4-.26-.82-.54-1.37-1.29-1.82-2.02-.12-.22-.01-.34.1-.44.09-.09.2-.23.29-.34.09-.11.13-.19.18-.31.05-.13.03-.24-.01-.34-.05-.08-.31-.76-.42-1.04-.11-.27-.22-.24-.31-.24h-.31c-.13 0-.34.05-.52.26-.18.22-.69.67-.69 1.62s.71 1.88.81 2c.09.11 1.39 2.13 3.41 3.01.49.21.88.34 1.18.44.49.17.63.14.86.12.24-.02.79-.32.9-.63.11-.31.11-.58.08-.63-.04-.04-.13-.09-.28-.15z"/></svg>
    </a>

    <footer class="app-footer">
        <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-8">
            <div class="lg:col-span-1">
                <h4 class="text-xl">Sobre el Programa</h4>
                <ul><li>Análisis Descriptivo</li><li>Visualización de Datos</li></ul>
            </div>
            
            <div class="lg:col-span-2">
                <h4 class="text-xl">Creador</h4>
                <div class="flex flex-col sm:flex-row items-center gap-4 text-center sm:text-left">
                    <div class="flex-shrink-0 flex gap-4">
                        <img src="https://i.ibb.co/3yL8JX3f/2.png" alt="Logo UNAS" class="h-20 w-20 object-contain">
                        <img src="https://i.ibb.co/GvwLjND4/1.png" alt="Logo Escuela" class="h-20 w-20 object-contain">
                    </div>
                    <div>
                        <p class="text-lg font-semibold text-white">José Caballero Livaque</p>
                        <p class="text-sm mt-1">Estudiante, <span class="font-medium">UNIVERSIDAD NACIONAL AGRARIA DE LA SELVA</span></p>
                        <p class="text-xs text-gray-400 mt-1">FACULTAD DE RECURSOS NATURALES RENOVABLES</p>
                        <p class="text-xs text-gray-400">ESCUELA PROFESIONAL DE INGENIERÍA EN CONSERVACIÓN DE SUELOS Y AGUA</p>
                    </div>
                </div>
            </div>

            <div>
                <h4 class="text-xl">Soporte y Donaciones</h4>
                <ul>
                    <li><a href="https://wa.me/51903422507" target="_blank">Contactar por WhatsApp</a></li>
                    <li>Reportar un error</li>
                </ul>
                <p class="text-sm mt-4 mb-2">Si esta herramienta te es útil, considera apoyar su desarrollo:</p>
                <img src="https://i.ibb.co/zh4TR6tD/Imagen-de-Whats-App-2025-10-18-a-las-00-25-27-96e5a932.jpg" alt="Código QR para donar" class="w-24 h-24 rounded-lg shadow-md">
            </div>
        </div>
        <div class="copyright">&copy; 2025 P4INN.</div>
    </footer>

    <div id="loadingOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex flex-col items-center justify-center z-50 hidden transition-opacity duration-300">
        <svg class="animate-spin h-16 w-16 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-white text-2xl font-bold tracking-widest animate-pulse">Cargando...</p>
        <p id="countdown" class="text-white text-7xl font-bold mt-2"></p>
    </div>

    <script>
        const analyzeBtn = document.getElementById('analyzeBtn');
        const analyzeBtnIcon = document.getElementById('analyzeBtnIcon');
        const analyzeBtnText = document.getElementById('analyzeBtnText');
        
        // Función para generar datos aleatorios
        const generateRandomData = (type = 'decimal', decimals = 2) => {
            const data = [];
            const count = 200; // Generar 200 números
            const min = 10;
            const max = 100;
            for (let i = 0; i < count; i++) {
                let randomNumber = Math.random() * (max - min) + min;
                if (type === 'decimal') { 
                    data.push(randomNumber.toFixed(decimals));
                } else { // 'integer'
                    data.push(Math.floor(randomNumber)); // Entero
                }
            }
            document.getElementById('rawData').value = data.join(', ');
        };

        // Event Listeners para botones de ejemplo
        document.getElementById('loadSampleIntBtn').addEventListener('click', () => generateRandomData('integer'));
        // CORRECCIÓN: ID del botón de decimales
        document.getElementById('loadSampleDec2Btn').addEventListener('click', () => generateRandomData('decimal', 2)); 
        document.getElementById('loadSampleDec4Btn').addEventListener('click', () => generateRandomData('decimal', 4));
        
        analyzeBtn.addEventListener('click', () => {
            const rawData = document.getElementById('rawData').value;
            const variableName = document.getElementById('variableName').value || 'Variable';
            const histColor = document.getElementById('histColor').value;
            // CORRECCIÓN: La variable 'analysisType' se eliminó del HTML, por lo que se elimina la referencia.
            // const analysisType = document.querySelector('input[name="analysisType"]:checked').value; // ESTA LÍNEA CAUSABA EL ERROR
            const dataArray = rawData.trim().split(/[\s,;\n]+/).filter(n => n !== '').map(Number).filter(n => !isNaN(n));

            if (dataArray.length < 5) {
                document.getElementById('results').innerHTML = `<div class="main-card p-6 text-center fade-in"><p class="text-red-600 font-semibold">Se necesitan al menos 5 puntos de datos para un análisis significativo.</p></div>`;
                return;
            }

            analyzeBtn.disabled = true;
            analyzeBtnIcon.classList.add('hidden'); 
            analyzeBtnText.textContent = 'Cargando...'; 
            
            const loadingOverlay = document.getElementById('loadingOverlay');
            const countdownElement = document.getElementById('countdown');
            loadingOverlay.classList.remove('hidden');
            
            let countdown = 2; // Cuenta regresiva de 2 segundos
            countdownElement.textContent = countdown;

            const interval = setInterval(() => {
                countdown--;
                if (countdown >= 0) {
                    countdownElement.textContent = countdown;
                }
                if (countdown < 0) {
                    clearInterval(interval);
                    loadingOverlay.classList.add('hidden');
                    setTimeout(() => {
                        // CORRECCIÓN: Se elimina 'analysisType' de la llamada a la función
                        analisisAPDACompleto(dataArray, variableName, histColor);
                        analyzeBtn.disabled = false;
                        analyzeBtnIcon.classList.remove('hidden'); 
                        analyzeBtnText.textContent = 'Analizar'; 
                    }, 50); 
                }
            }, 1000);
        });

        function copyToClipboard(text, button) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus(); textArea.select();
            try {
                document.execCommand('copy');
                const originalContent = button.innerHTML;
                button.innerHTML = '¡Copiado!';
                button.classList.add('text-emerald-500');
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.classList.remove('text-emerald-500');
                }, 1500);
            } catch (err) { console.error('Error al copiar texto: ', err); }
            document.body.removeChild(textArea);
        }
        
        function formatNumber(num, maxDecimals = 5) {
            if (isNaN(num) || num === null) return 'N/A';
            const factor = Math.pow(10, maxDecimals);
            let roundedNum = Math.round(num * factor) / factor; 
            let numStr = roundedNum.toString(); 
            if (numStr.indexOf('.') === -1) { return numStr; }
            numStr = roundedNum.toFixed(maxDecimals);
            numStr = numStr.replace(/(\.\d*?[1-9])0+$/, '$1'); 
            numStr = numStr.replace(/\.0+$/, '');
             if (numStr.endsWith('.')) { numStr = numStr.slice(0, -1); }
            return numStr; 
        }
        
        function formatDisplay(num, decimals = 3){
             if (isNaN(num) || num === null) return 'N/A';
             return num.toFixed(decimals);
        }
        
        function formatAPDA(num, decimals = 4) {
             if (isNaN(num) || num === null) return 'N/A';
             return num.toFixed(decimals);
        }


        // --- Función Principal de Análisis ---
        // CORRECCIÓN: Se elimina 'analysisType' de la definición de la función
        function analisisAPDACompleto(y, nombre_variable, color_hist) {
            const resultsDiv = document.getElementById('results');
            document.getElementById('initialState')?.remove();
            resultsDiv.innerHTML = ''; 

            const n_ind = y.length; 
            if (n_ind === 0) return; 
            const vlrmax = Math.max(...y); 
            const vlrmin = Math.min(...y); 
            const rango = vlrmax - vlrmin;
            
            // --- CÁLCULO DE DATOS NO AGRUPADOS ---
            const y_sorted = [...y].sort((a, b) => a - b);
            const mean_orig = y.reduce((a, b) => a + b, 0) / n_ind;
            const var_orig = n_ind > 1 ? y.reduce((sum, val) => sum + Math.pow(val - mean_orig, 2), 0) / (n_ind - 1) : 0;
            const sd_orig = Math.sqrt(var_orig);
            const cv_orig = (mean_orig !== 0) ? (sd_orig / mean_orig) * 100 : NaN;
            
            const percentile_orig = (p) => {
                const index = p * (n_ind - 1);
                const lower_index = Math.floor(index);
                const upper_index = Math.ceil(index);
                const fraction = index - lower_index;
                if (lower_index === upper_index) return y_sorted[lower_index];
                return y_sorted[lower_index] + (y_sorted[upper_index] - y_sorted[lower_index]) * fraction;
            };

            const median_orig = percentile_orig(0.5);
            const q1_orig = percentile_orig(0.25);
            const q3_orig = percentile_orig(0.75);
            const d1_orig = percentile_orig(0.10);
            const d9_orig = percentile_orig(0.90);

            // --- CÁLCULO DE DATOS AGRUPADOS ---
            let n_clases, amp, puntos;

            // CORRECCIÓN: Se usa la lógica 'APDA (Clásico)' por defecto y se elimina el 'else'
            n_clases = Math.round(1 + 3.3 * Math.log10(n_ind));
            if (n_clases <= 0) n_clases = 1;
            amp = (rango === 0) ? 1 : rango / n_clases;
            puntos = Array.from({ length: n_clases + 1 }, (_, i) => vlrmin + i * amp);
           

            if (n_clases <= 0) {
                 resultsDiv.innerHTML = `<div class="main-card p-6 text-center fade-in"><p class="text-red-600 font-semibold">No se pudieron generar intervalos. Verifique sus datos (rango=${rango}, amp=${amp}).</p></div>`;
                 return;
            }

            let LimInf = [], LimSup = [], Xi = [], fabs = Array(n_clases).fill(0);
            
            for (let i = 0; i < n_clases; i++) {
                LimInf[i] = puntos[i]; 
                LimSup[i] = puntos[i+1]; 
                Xi[i] = (puntos[i] + puntos[i+1]) / 2;
                
                const lowerBound = LimInf[i];
                const upperBound = LimSup[i];
                const isLastClass = (i === n_clases - 1);
                
                fabs[i] = y.filter(val => {
                    const tolerance = 1e-9; 
                    const checkLower = val >= lowerBound - tolerance;
                    const checkUpper = isLastClass ? val <= upperBound + tolerance : val < upperBound - tolerance;
                    return checkLower && checkUpper;
                }).length;
            }
            
            // --- Cálculos Estadísticos (Agrupados) ---
            const fabsacum = fabs.reduce((acc, val, i) => [...acc, (acc[i-1] || 0) + val], []);
            const frel = fabs.map(f => f / n_ind); const frelPor = frel.map(h => h * 100);
            const frelacum = frel.reduce((acc, val, i) => [...acc, (acc[i-1] || 0) + val], []); const frelacumPor = frelacum.map(h => h * 100);
            const P_Mues = Xi.reduce((sum, val, i) => sum + val * fabs[i], 0) / n_ind;
            const n_medios = n_ind / 2; const w = fabsacum.findIndex(f => f >= n_medios - 1e-9); // Tolerancia
            const F_anterior_med = (w === 0) ? 0 : fabsacum[w-1];
            const Me_Mues = (w === -1 || fabs[w] === 0) ? NaN : LimInf[w] + (((n_medios - F_anterior_med) / fabs[w]) * amp);
            
            const u = fabs.indexOf(Math.max(...fabs)); const d1_moda = fabs[u] - (fabs[u-1] || 0); const d2_moda = fabs[u] - (fabs[u+1] || 0);
            const Mo_Mues = (d1_moda + d2_moda === 0 || u === -1) ? NaN : LimInf[u] + (d1_moda / (d1_moda + d2_moda)) * amp; 

            const valid_xi_gt_0 = Xi.filter((x,i) => fabs[i] > 0 && x > 0);
            const valid_fabs_gt_0 = fabs.filter((f,i) => f > 0 && Xi[i] > 0);
            const sum_log = valid_xi_gt_0.reduce((sum, val, i) => sum + valid_fabs_gt_0[i] * Math.log10(val), 0); 
            const count_gt_0 = valid_fabs_gt_0.reduce((s,f) => s+f, 0);
            const Me_Geo = count_gt_0 > 0 ? Math.pow(10, sum_log / count_gt_0) : NaN;

            const valid_xi_ne_0 = Xi.filter((x,i) => fabs[i] > 0 && x !== 0);
            const valid_fabs_ne_0 = fabs.filter((f,i) => f > 0 && Xi[i] !== 0);
            const sum_inv = valid_xi_ne_0.reduce((sum, val, i) => sum + valid_fabs_ne_0[i] / val, 0); 
            const count_ne_0 = valid_fabs_ne_0.reduce((s,f) => s+f, 0);
            const Me_Arm = (count_ne_0 > 0 && sum_inv !== 0) ? count_ne_0 / sum_inv : NaN;

            const sum_sq_diff = Xi.reduce((sum, val, i) => sum + Math.pow(val - P_Mues, 2) * fabs[i], 0); 
            const Va_Mues = n_ind > 1 ? sum_sq_diff / (n_ind - 1) : 0; 
            const Des_Est = Math.sqrt(Va_Mues); 
            const Cof_Var = (P_Mues !== 0) ? (Des_Est / P_Mues) * 100 : NaN; 

            const calcular_cuantil = (k, q) => { const pos = (k * n_ind) / q; const clase = fabsacum.findIndex(f => f >= pos - 1e-9); if (clase === -1 || fabs[clase] === 0) return { cuantil: NaN, Li: (clase === -1 ? NaN : LimInf[clase]), pos, Fi_ant: (clase === -1 ? NaN : (clase === 0 ? 0 : fabsacum[clase-1])), fi: (clase === -1 ? NaN : fabs[clase])}; const F_ant = (clase === 0) ? 0 : fabsacum[clase - 1]; return { cuantil: LimInf[clase] + (((pos - F_ant) / fabs[clase]) * amp), Li: LimInf[clase], pos, Fi_ant: F_ant, fi: fabs[clase]}; };
            const q1_calc = calcular_cuantil(1, 4); const q3_calc = calcular_cuantil(3, 4); 
            const d1_calc = calcular_cuantil(1, 10); const d9_calc = calcular_cuantil(9, 10);
            
            const asimetria = (Des_Est !== 0 && !isNaN(Mo_Mues)) ? (P_Mues - Mo_Mues) / Des_Est : NaN; 
            const sum_pow4_diff = Xi.reduce((sum, val, i) => sum + fabs[i] * Math.pow(val - P_Mues, 4), 0); 
            const m4 = sum_pow4_diff / n_ind;
            const curtosis = (Des_Est !== 0 && Des_Est > 1e-9) ? m4 / Math.pow(Des_Est, 4) - 3 : NaN; 

            // --- GENERACIÓN DE HTML ---
            
            const createAccordion = (title, resultValue, formula, development, result) => {
                 const finalResultValue = typeof resultValue === 'number' ? formatDisplay(resultValue, 3) : resultValue; // Mostrar resultado con 3 decimales
                const textToCopy = `Cálculo: ${title}\n\nFórmula:\n${formula.replace(/\\/g, '').replace(/\$\$/g, '')}\n\nDesarrollo:\n${development.replace(/<div.+?>|<\/div>|<p.+?>|<\/p>/g, '\n').replace(/\\/g, '').replace(/\$\$/g, '').replace(/; ;/g, ';').replace(/\s{2,}/g, ' ').trim()}\n\nResultado:\n${result.replace(/\\/g, '').replace(/\$\$/g, '')}`;
                const formulaHtml = `<h4>Fórmula <button class="copy-btn" onclick="copyToClipboard(\`${textToCopy.replace(/`/g, "\\`")}\`, this.parentElement)"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></button></h4>${formula}`;
                return `<details class="accordion-item"><summary><div class="flex-grow"><span class="font-semibold text-lg text-gray-700">${title}</span></div><span class="font-bold text-lg text-indigo-600">${finalResultValue}</span></summary><div class="accordion-content"><div class="calculation-step">${formulaHtml}</div><div class="calculation-step"><h4>Desarrollo</h4><div class="scrollable-equation">${development}</div></div><div class="calculation-step"><h4>Resultado</h4>${result}</div></div></details>`;
            };

            // --- 1. Tarjeta de Estadísticas Directas (No Agrupadas) ---
            let directStatsHTML = `<div class="main-card p-6 fade-in"><h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center"><svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Análisis de Datos Originales (No Agrupados)</h2><div class="space-y-4">`;
            
            const dev_mean_orig = `$$ \\bar{x} = \\frac{${y.map(v => formatNumber(v)).join(' + ')}}{${n_ind}} $$ <p class="whitespace-normal mt-4">$$ \\bar{x} = \\frac{${formatNumber(mean_orig * n_ind)}}{${n_ind}} $$</p>`;
            const dev_var_orig = `$$ S^2 = \\frac{${y.map(v => `(${formatNumber(v)} - ${formatNumber(mean_orig)})^2`).join(' + ')}}{${n_ind - 1}} $$ <p class="whitespace-normal mt-4">$$ S^2 = \\frac{${formatNumber(var_orig * (n_ind - 1))}}{${n_ind - 1}} $$</p>`;
            
            directStatsHTML += createAccordion('Media (No Agrupada)', formatDisplay(mean_orig, 3), '$$ \\bar{x} = \\frac{\\sum x_i}{n} $$', dev_mean_orig, `$$ \\bar{x} = ${formatNumber(mean_orig, 5)} $$`);
            directStatsHTML += createAccordion('Mediana (No Agrupada)', formatDisplay(median_orig, 3), '$$ Me = Valor \\; en \\; pos \\; 0.5(n+1) $$', `<p class="whitespace-normal">$$ Me = Valor \\; en \\; pos \\; ${formatNumber(0.5*(n_ind+1), 1)} $$</p><p class="whitespace-normal mt-2">Se interpola entre los valores de la lista ordenada.</p>`, `$$ Me = ${formatNumber(median_orig, 5)} $$`);
            directStatsHTML += createAccordion('Varianza (No Agrupada)', formatDisplay(var_orig, 3), '$$ S^2 = \\frac{\\sum (x_i - \\bar{x})^2}{n-1} $$', dev_var_orig, `$$ S^2 = ${formatNumber(var_orig, 5)} $$`);
            directStatsHTML += createAccordion('Desv. Estándar (No Agrupada)', formatDisplay(sd_orig, 3), '$$ S = \\sqrt{S^2} $$', `<p class="whitespace-normal">$$ S = \\sqrt{${formatNumber(var_orig, 5)}} $$</p>`, `$$ S = ${formatNumber(sd_orig, 5)} $$`);
            directStatsHTML += createAccordion('Coef. de Variación (No Agrupado)', `${formatDisplay(cv_orig, 3)} %`, '$$ CV = \\frac{S}{\\bar{x}} \\cdot 100\\% $$', `<p class="whitespace-normal">$$ CV = \\frac{${formatNumber(sd_orig, 5)}}{${formatNumber(mean_orig, 5)}} \\cdot 100\\% $$</p>`, `$$ CV = ${formatNumber(cv_orig, 5)}\\% $$`);
            directStatsHTML += `</div></div>`;


            // --- 2. Tarjeta de Análisis Agrupado ---
            let groupedHTML = `<div class="main-card p-6 fade-in"><h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center"><svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>Análisis de Datos Agrupados (Método APDA Clásico)</h2>`;

            // 2.1 Tabla de Frecuencias
            groupedHTML += `<h3 class="text-xl font-semibold text-gray-700 mb-3 mt-4">2.1. Tabla de Frecuencias</h3><div class="overflow-x-auto"><table class="result-table w-full"><thead><tr>`;
            
            // CORRECCIÓN: Se usa solo la lógica de formato 'APDA (Clásico)'
            groupedHTML += `<th>[   Li</th><th>   Ls ></th><th>     xi</th><th>F.A</th><th>F.A.A</th><th>F.R</th><th>F.R.A</th><th>F.R.%</th></tr></thead><tbody>`;
            for (let i = 0; i < n_clases; i++) { groupedHTML += `<tr><td>${formatAPDA(LimInf[i], 4)}</td><td>${formatAPDA(LimSup[i], 4)}</td><td>${formatAPDA(Xi[i], 4)}</td><td>${fabs[i]}</td><td>${fabsacum[i]}</td><td>${formatDisplay(frel[i], 2)}</td><td>${formatDisplay(frelacum[i], 2)}</td><td>${Math.round(frelPor[i])}</td></tr>`; }
            groupedHTML += `</tbody></table><div class="mt-4"><h4 class="font-semibold">F.R.A.%</h4><pre class="bg-gray-100 p-2 rounded overflow-x-auto">`;
            for(let i = 0; i < n_clases; i++){ groupedHTML += `${i+1}\t${Math.round(frelacumPor[i])}\n`; }
            groupedHTML += `</pre></div>`;
            
            groupedHTML += `</div>`;

            // 2.2 Histograma
            groupedHTML += `<h3 class="text-xl font-semibold text-gray-700 mb-3 mt-8">2.2. Histograma</h3><div class="chart-container"><div class="chart-area"><div class="chart-title">Distribución de ${nombre_variable}</div><div class="y-axis-title">Frecuencia</div><div class="x-axis-title">${nombre_variable}</div><div class="chart-scroll-wrapper"><div class="chart" style="min-width: ${n_clases * 60}px">`;
            const maxFreq = Math.max(...fabs, 1); 
            const histRange = (LimSup[n_clases-1] - LimInf[0]);
            const meanPositionPercent = histRange > 0 ? ((P_Mues - LimInf[0]) / histRange) * 100 : 50; 
            for(let i=0; i < n_clases; i++) { groupedHTML += `<div class="bar-wrapper" style="width: ${100/n_clases}%"><div class="bar" style="height: ${(fabs[i]/maxFreq)*100}%; background-color: ${color_hist};"><span class="bar-label">${fabs[i]}</span></div><span class="interval-label">${formatNumber(LimInf[i],1)}</span></div>`; }
            groupedHTML += `<div class="mean-line" style="left: ${meanPositionPercent}%;"><div class="mean-legend">-- Media (Agrup.) = ${formatDisplay(P_Mues, 2)}</div></div></div></div></div></div>`;

            // 2.3 Cálculos Detallados (Agrupados)
            groupedHTML += `<h3 class="text-xl font-semibold text-gray-700 mb-3 mt-8">2.3. Cálculo Detallado (Datos Agrupados)</h3><div class="space-y-4">`;
            
            const dev_P_Mues = `$$ \\bar{x} = \\frac{${Xi.map((xi, i) => `(${formatNumber(xi)} \\cdot ${fabs[i]})`).join(' + ')}}{${n_ind}} $$ <p class="whitespace-normal mt-4">$$ \\bar{x} = \\frac{${formatNumber(P_Mues*n_ind)}}{${n_ind}} $$</p>`;
            const dev_Me_Mues = `<p class="whitespace-normal">$$ Me = ${formatNumber(LimInf[w])} + \\left( \\frac{\\frac{${n_ind}}{2} - ${F_anterior_med}}{${fabs[w]}} \\right) \\cdot ${formatNumber(amp)} = ${formatNumber(LimInf[w])} + \\left( \\frac{${n_medios} - ${F_anterior_med}}{${fabs[w]}} \\right) \\cdot ${formatNumber(amp)} $$</p>`;
            const dev_Mo_Mues = `<p class="whitespace-normal">$$ d_1 = ${fabs[u]} - ${fabs[u-1] || 0} = ${d1_moda} ; \\; d_2 = ${fabs[u]} - ${fabs[u+1] || 0} = ${d2_moda} $$</p> <p class="whitespace-normal mt-4">$$ Mo = ${formatNumber(LimInf[u])} + \\left( \\frac{${d1_moda}}{${d1_moda} + ${d2_moda}} \\right) \\cdot ${formatNumber(amp)} $$</p>`;
            const dev_Me_Geo = `$$ Xg = \\text{antilog} \\left( \\frac{${Xi.map((xi, i) => `(${fabs[i]} \\cdot \\log_{10}(${formatNumber(xi)}))`).join(' + ')}}{${n_ind}} \\right) $$ <p class="whitespace-normal mt-4">$$ Xg = \\text{antilog} \\left( \\frac{${formatNumber(sum_log)}}{${n_ind}} \\right) $$</p>`;
            const dev_Me_Arm = `$$ Xh = \\frac{${n_ind}}{${Xi.map((xi, i) => `\\frac{${fabs[i]}}{${formatNumber(xi)}}`).join(' + ')}} $$ <p class="whitespace-normal mt-4">$$ Xh = \\frac{${n_ind}}{${formatNumber(sum_inv)}} $$</p>`;
            const dev_Va_Mues = `$$ S^2 = \\frac{${Xi.map((xi, i) => `(${formatNumber(xi)} - ${formatNumber(P_Mues)})^2 \\cdot ${fabs[i]}`).join(' + ')}}{${n_ind-1}} $$ <p class="whitespace-normal mt-4">$$ S^2 = \\frac{${formatNumber(sum_sq_diff)}}{${n_ind-1}} $$</p>`;
            const dev_Curtosis = `$$ g_2 = \\frac{${Xi.map((xi, i) => `${fabs[i]} \\cdot (${formatNumber(xi)} - ${formatNumber(P_Mues)})^4`).join(' + ')}}{${n_ind} \\cdot {(${formatNumber(Des_Est)})}^4} - 3 $$ <p class="whitespace-normal mt-4">$$ g_2 = \\frac{${formatNumber(m4)}}{{(${formatNumber(Des_Est)})}^4} - 3 $$</p>`;

            groupedHTML += createAccordion('Media Aritmética (Agrupada)', formatDisplay(P_Mues, 3), '$$ \\bar{x} = \\frac{\\sum (x_i \\cdot f_i)}{n} $$', dev_P_Mues, `$$ \\bar{x} = ${formatNumber(P_Mues, 5)} $$`);
            groupedHTML += createAccordion('Mediana (Agrupada)', formatDisplay(Me_Mues, 3), '$$ Me = L_i + \\left( \\frac{\\frac{n}{2} - F_{i-1}}{f_i} \\right) \\cdot C $$', dev_Me_Mues, `$$ Me = ${formatNumber(Me_Mues, 5)} $$`);
            groupedHTML += createAccordion('Moda (Agrupada)', formatDisplay(Mo_Mues, 3), '$$ Mo = L_i + \\left( \\frac{d_1}{d_1 + d_2} \\right) \\cdot C $$', dev_Mo_Mues, `$$ Mo = ${formatNumber(Mo_Mues, 5)} $$`);
            groupedHTML += createAccordion('Media Geométrica (Agrupada)', formatDisplay(Me_Geo, 3), '$$ Xg = \\text{antilog} \\left( \\frac{\\sum (f_i \\cdot \\log_{10}(x_i))}{n} \\right) $$', dev_Me_Geo, `$$ Xg = ${formatNumber(Me_Geo, 5)} $$`);
            groupedHTML += createAccordion('Media Armónica (Agrupada)', formatDisplay(Me_Arm, 3), '$$ Xh = \\frac{n}{\\sum \\frac{f_i}{x_i}} $$', dev_Me_Arm, `$$ Xh = ${formatNumber(Me_Arm, 5)} $$`);
            groupedHTML += createAccordion('Varianza (Agrupada)', formatDisplay(Va_Mues, 3), '$$ S^2 = \\frac{\\sum (x_i - \\bar{x})^2 \\cdot f_i}{n-1} $$', dev_Va_Mues, `$$ S^2 = ${formatNumber(Va_Mues, 5)} $$`);
            groupedHTML += createAccordion('Desviación Estándar (Agrupada)', formatDisplay(Des_Est, 3), '$$ S = \\sqrt{S^2} $$', `<p class="whitespace-normal">$$ S = \\sqrt{${formatNumber(Va_Mues, 5)}} $$</p>`, `$$ S = ${formatNumber(Des_Est, 5)} $$`);
            groupedHTML += createAccordion('Coeficiente de Variación (Agrupado)', `${formatDisplay(Cof_Var, 3)} %`, '$$ CV = \\frac{S}{\\bar{x}} \\cdot 100\\% $$', `<p class="whitespace-normal">$$ CV = \\frac{${formatNumber(Des_Est, 5)}}{${formatNumber(P_Mues, 5)}} \\cdot 100\\% $$</p>`, `$$ CV = ${formatNumber(Cof_Var, 5)}\\% $$`);
            groupedHTML += createAccordion('Cuartil 1 (Q1)', formatDisplay(q1_calc.cuantil, 3), '$$ Q_1 = L_i + \\left( \\frac{\\frac{1 \\cdot n}{4} - F_{i-1}}{f_i} \\right) \\cdot C $$', `<p class="whitespace-normal">$$ Q_1 = ${formatNumber(q1_calc.Li, 5)} + \\left( \\frac{${formatNumber(q1_calc.pos, 2)} - ${q1_calc.Fi_ant}}{${q1_calc.fi}} \\right) \\cdot ${formatNumber(amp, 5)} $$</p>`, `$$ Q_1 = ${formatNumber(q1_calc.cuantil, 5)} $$`);
            groupedHTML += createAccordion('Cuartil 3 (Q3)', formatDisplay(q3_calc.cuantil, 3), '$$ Q_3 = L_i + \\left( \\frac{\\frac{3 \\cdot n}{4} - F_{i-1}}{f_i} \\right) \\cdot C $$', `<p class="whitespace-normal">$$ Q_3 = ${formatNumber(q3_calc.Li, 5)} + \\left( \\frac{${formatNumber(q3_calc.pos, 2)} - ${q3_calc.Fi_ant}}{${q3_calc.fi}} \\right) \\cdot ${formatNumber(amp, 5)} $$</p>`, `$$ Q_3 = ${formatNumber(q3_calc.cuantil, 5)} $$`);
            groupedHTML += createAccordion('Decil 1 (D1)', formatDisplay(d1_calc.cuantil, 3), '$$ D_1 = L_i + \\left( \\frac{\\frac{1 \\cdot n}{10} - F_{i-1}}{f_i} \\right) \\cdot C $$', `<p class="whitespace-normal">$$ D_1 = ${formatNumber(d1_calc.Li, 5)} + \\left( \\frac{${formatNumber(d1_calc.pos, 2)} - ${d1_calc.Fi_ant}}{${d1_calc.fi}} \\right) \\cdot ${formatNumber(amp, 5)} $$</p>`, `$$ D_1 = ${formatNumber(d1_calc.cuantil, 5)} $$`);
            groupedHTML += createAccordion('Decil 9 (D9)', formatDisplay(d9_calc.cuantil, 3), '$$ D_9 = L_i + \\left( \\frac{\\frac{9 \\cdot n}{10} - F_{i-1}}{f_i} \\right) \\cdot C $$', `<p class="whitespace-normal">$$ D_9 = ${formatNumber(d9_calc.Li, 5)} + \\left( \\frac{${formatNumber(d9_calc.pos, 2)} - ${d9_calc.Fi_ant}}{${d9_calc.fi}} \\right) \\cdot ${formatNumber(amp, 5)} $$</p>`, `$$ D_9 = ${formatNumber(d9_calc.cuantil, 5)} $$`);
            groupedHTML += createAccordion('Asimetría (Pearson)', formatDisplay(asimetria, 3), '$$ As = \\frac{\\bar{x} - Mo}{S} $$', `<p class="whitespace-normal">$$ As = \\frac{${formatNumber(P_Mues, 5)} - ${formatNumber(Mo_Mues, 5)}}{${formatNumber(Des_Est, 5)}} $$</p>`, `$$ As = ${formatNumber(asimetria, 5)} $$`);
            groupedHTML += createAccordion('Curtosis (Exceso)', formatDisplay(curtosis, 3), '$$ g_2 = \\frac{\\sum f_i (x_i - \\bar{x})^4}{n \\cdot S^4} - 3 $$', dev_Curtosis, `$$ g_2 = ${formatNumber(curtosis, 5)} $$`);
            
            groupedHTML += `</div></div>`; // Cierre de la tarjeta de Cálculos Detallados
            
            resultsDiv.innerHTML = directStatsHTML + groupedHTML;
            
            MathJax.typeset();
        }
    </script>
</body>
</html>
